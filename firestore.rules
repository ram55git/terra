rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions for validation
    function isValidLatitude(lat) {
      return lat is number && lat >= -90 && lat <= 90;
    }
    
    function isValidLongitude(lon) {
      return lon is number && lon >= -180 && lon <= 180;
    }
    
    function isValidMode(mode) {
      return mode is string && mode in ['Complaint', 'Compliment'];
    }
    
    function isValidTimestamp(ts) {
      return ts is string 
        && ts.matches('^[0-9]{4}-[0-9]{2}-[0-9]{2}T.*');
    }
    
    function hasRequiredFields(data) {
      return data.keys().hasAll(['mode', 'userId', 'location', 'address', 'selectedTiles', 'timestamp']);
    }
    
    function hasValidLocation(location) {
      return location.keys().hasAll(['lat', 'lon'])
        && isValidLatitude(location.lat)
        && isValidLongitude(location.lon);
    }
    
    // Submissions collection rules
    match /submissions/{submissionId} {
      // Allow read for all users (public map viewing)
      allow read: if true;
      
      // Allow create with validation
      allow create: if hasRequiredFields(request.resource.data)
        && isValidMode(request.resource.data.mode)
        && hasValidLocation(request.resource.data.location)
        && isValidTimestamp(request.resource.data.timestamp)
        && request.resource.data.userId is string
        && request.resource.data.userId.size() > 0
        && request.resource.data.userId.size() < 200
        && request.resource.data.address is string
        && request.resource.data.address.size() < 500
        && request.resource.data.selectedTiles is map
        && request.resource.data.selectedTiles.size() > 0
        && request.resource.data.selectedTiles.size() <= 20;
      
      // No updates allowed - submissions are immutable
      allow update: if false;
      
      // No deletes allowed - maintain data integrity
      allow delete: if false;
    }
    
    // Deny all other collections by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}